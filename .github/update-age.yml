name: Update Age

permissions:
  contents: write

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch: {} 
  push:
    branches:
      - main

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Calculate age and update README
      env:
        BIRTHDATE: '2001-02-25'
      run: |
        python - <<'PY'
        from datetime import date, datetime
        import os
        import re

        birthdate = os.environ.get('BIRTHDATE', '2001-02-25')
        birth = datetime.strptime(birthdate, '%Y-%m-%d').date()
        today = date.today()
        age = today.year - birth.year - ((today.month, today.day) < (birth.month, birth.day))

        path = 'README.md'
        with open(path, 'r', encoding='utf-8') as f:
          text = f.read()

        token, n_token = re.subn(r'\{\{AGE\}\}', str(age), text)

        if n_token:
          with open(path, 'w', encoding='utf-8') as f:
            f.write(token)
          print(f'Updated README.md with age {age}')
        else:
          print('No AGE token found in README.md')
        PY

    - name: Commit & push if changed
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add README.md || true
        if git diff --staged --quiet; then
          echo 'No changes to commit'
        else
          git commit -m "Update age in README"
          git push
        fi
